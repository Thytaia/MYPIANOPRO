<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Interativo (C2 a F#7 - 67 Teclas)</title>
    <!-- Carrega a biblioteca Tone.js -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.min.js"></script>
    <!-- Carrega Tailwind CSS para estilização responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos Customizados do Piano */
        .piano-key {
            transition: background-color 0.05s ease, transform 0.05s ease;
            cursor: pointer;
            user-select: none;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            font-weight: 500;
        }

        /* CHAVES BRANCAS: Dimensões reduzidas para caber 5.5 oitavas sem scroll */
        .white-key {
            width: 30px; /* NEW: Reduzido de 40px */
            height: 150px; /* NEW: Reduzido de 180px */
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-top: none; 
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            margin-right: 1px;
            z-index: 1;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
        }

        /* CHAVES PRETAS: Dimensões e posicionamento ajustados */
        .black-key {
            width: 18px; /* NEW: Reduzido de 24px */
            height: 90px; /* NEW: Reduzido de 110px */
            background-color: #1f2937;
            border-radius: 0 0 3px 3px;
            position: absolute;
            top: 0;
            left: -9px; /* Ajuste: Metade da largura da tecla preta */
            z-index: 2;
            color: white;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.8);
            border: 1px solid #000;
        }
        
        /* Ajuste do texto dentro das teclas brancas para o novo tamanho */
        .white-key .key-label {
            font-size: 0.8rem;
            line-height: 1rem;
        }

        .white-key .note-label {
            font-size: 0.6rem;
        }
        
        /* Remoção do texto das teclas pretas para maximizar a área de clique */
        .black-key .key-text {
            display: none;
        }

        .key-active.white-key {
            background-color: #ffe0b2;
            transform: translateY(2px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
        }

        .key-active.black-key {
            background-color: #0d1218; 
            transform: translateY(2px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
        }

        .octave-group {
            display: flex;
            margin-right: 2px; /* Espaço entre oitavas */
        }
        .key-container {
            position: relative;
            flex-grow: 0; 
        }
        
        /* Estilo Específico para o LCD */
        .lcd-display {
            background-color: #1d352b; 
            color: #b8f1c4; 
            font-family: 'monospace', 'Courier New', Courier;
            border: 3px solid #0f172a;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
        }

        /* Estilo do Knob */
        .knob {
            width: 40px;
            height: 40px;
            background: linear-gradient(to top, #374151, #1f2937);
            border-radius: 50%;
            border: 2px solid #6b7280;
            position: relative;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5), inset 0 0 8px rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .knob-marker {
            position: absolute;
            top: 2px;
            width: 4px;
            height: 15px;
            background-color: #ef4444; 
            border-radius: 2px;
            transform-origin: center 18px; 
        }
        
        /* Responsividade para telas menores (mantida para garantir a usabilidade em mobile) */
        @media (max-width: 640px) {
            .white-key { width: 25px; height: 130px; }
            .black-key { width: 15px; height: 75px; left: -7.5px; }
            .octave-group { margin-right: 1px; }
            .knob { width: 30px; height: 30px; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Overlay de Início de Áudio -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900/90 flex items-center justify-center z-50 transition-opacity duration-500">
        <div class="text-xl font-semibold text-white p-6 bg-gray-800 rounded-lg shadow-2xl animate-pulse">
            Clique em qualquer lugar para carregar os timbres e começar a tocar.
        </div>
    </div>

    <div class="w-full max-w-[1240px] mx-auto p-4 bg-gray-200 rounded-xl shadow-2xl border-b-8 border-gray-400">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-4 text-center">
            Piano Digital Interativo (C2 a F#7 - 67 Teclas)
        </h1>
        
        <!-- PAINEL DE CONTROLE -->
        <div id="control-panel" class="mb-6 p-4 bg-gray-800 rounded-lg shadow-inner text-white flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
            
            <!-- LCD Display para Timbre Atual -->
            <div class="w-full md:w-1/3 text-left">
                <p class="text-sm font-light text-gray-400 mb-1">Timbre Atual:</p>
                <div class="lcd-display rounded-lg">
                    <p id="current-timbre-display" class="text-2xl font-mono font-bold whitespace-nowrap overflow-hidden">Carregando...</p>
                </div>
            </div>

            <!-- Knobs de Efeitos -->
            <div class="flex flex-wrap justify-center space-x-4">
                <!-- Knob 1: Reverb -->
                <div class="flex flex-col items-center">
                    <div id="knob-reverb" class="knob" data-effect="reverb" data-value="0.5" data-min="0" data-max="1">
                        <div class="knob-marker" style="transform: rotate(-45deg);"></div>
                    </div>
                    <p class="text-xs mt-1 text-gray-400">REVERB</p>
                </div>
                
                <!-- Knob 2: Chorus -->
                <div class="flex flex-col items-center">
                    <div id="knob-chorus" class="knob" data-effect="chorus" data-value="0.0" data-min="0" data-max="1">
                        <div class="knob-marker" style="transform: rotate(-135deg);"></div>
                    </div>
                    <p class="text-xs mt-1 text-gray-400">CHORUS</p>
                </div>
                
                <!-- Knob 3: Tremolo -->
                <div class="flex flex-col items-center">
                    <div id="knob-tremolo" class="knob" data-effect="tremolo" data-value="0.0" data-min="0" data-max="1">
                        <div class="knob-marker" style="transform: rotate(-135deg);"></div>
                    </div>
                    <p class="text-xs mt-1 text-gray-400">TREMOLO</p>
                </div>
                
                <!-- Knob 4: Drive -->
                <div class="flex flex-col items-center">
                    <div id="knob-drive" class="knob" data-effect="drive" data-value="0.0" data-min="0" data-max="0.8">
                        <div class="knob-marker" style="transform: rotate(-135deg);"></div>
                    </div>
                    <p class="text-xs mt-1 text-gray-400">DRIVE</p>
                </div>
            </div>

            <!-- Instrução INSERT -->
            <div class="w-full md:w-auto text-center md:text-right">
                <p class="text-sm font-light text-gray-400">Trocar Timbre (22 Presets):</p>
                <div class="flex items-center justify-center md:justify-end space-x-2 mt-1">
                    <span class="text-lg font-bold bg-gray-700 py-1 px-3 rounded-md shadow-md">INSERT</span>
                    <span class="text-base text-gray-400">próximo</span>
                </div>
            </div>
        </div>
        
        <!-- Container do Piano (Agora 67 teclas devem caber no max-w) -->
        <div id="piano" class="flex justify-center p-2 bg-gray-900 rounded-lg shadow-inner border-b-4 border-gray-700">
            <!-- O Piano será renderizado aqui -->
        </div>

        <!-- Legenda do Mapeamento de Teclas -->
        <div class="mt-8 p-4 bg-gray-50 rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-gray-700 mb-3 text-center">Mapeamento de Teclado (PC)</h2>
            <p class="text-center text-gray-600 text-sm">
                **C3-B3 (Oitava Central):** (Linha inferior) Z, S, X, D, C, V, G, B, H, N, J, M | 
                **C4-B4 (Mão Direita):** (Linha do meio) A, W, S, E, D, F, T, G, Y, H, U, J |
                **C5-B5 (Agudo):** (Linha superior) K, O, L, P, ;, ', [, ], -, =, 0, \ 
                <!-- Note: Keys '1', 'Q', '2', 'R', '3', 'T', '4' map to C6 to F#6 -->
            </p>
        </div>
    </div>

    <script type="module">
        // --- DADOS DO PIANO E TECLADO (C2 a F#7, 67 notas) ---
        // Mapeamento de teclas físicas (QWERTY) para notas (C3-C6 é o foco de jogabilidade)
        const KEY_TO_NOTE = {
            // Oitava 3 (Z-M row) - 12 notes
            'z': 'C3', 's': 'C#3', 'x': 'D3', 'd': 'D#3', 'c': 'E3', 'v': 'F3', 'g': 'F#3', 'b': 'G3', 'h': 'G#3', 'n': 'A3', 'j': 'A#3', 'm': 'B3',

            // Oitava 4 (A-J row) - 12 notes
            'a': 'C4', 'w': 'C#4', 's': 'D4', 'e': 'D#4', 'd': 'E4', 'f': 'F4', 't': 'F#4', 'g': 'G4', 'y': 'G#4', 'h': 'A4', 'u': 'A#4', 'j': 'B4',

            // Oitava 5 (K-symbols row) - 12 notes (adaptado para teclados brasileiros/europeus)
            'k': 'C5', 'o': 'C#5', 'l': 'D5', 'p': 'D#5', ';': 'E5', '\'': 'F5', '[': 'F#5', ']': 'G5', '-': 'G#5', '=': 'A5', '0': 'A#5', '\\': 'B5',
            
            // Oitava 6 (Numbers/Top Row) - 7 notes
            '1': 'C6', 'q': 'C#6', '2': 'D6', 'r': 'D#6', '3': 'E6', 't': 'F6', '5': 'F#6'
        };

        // Estrutura das teclas para renderização da interface (C2 a F#7)
        const NOTES_SEQUENCE = [
            // C2 (12 notas)
            { note: 'C2', key: 'C2', type: 'white', hasSharp: true }, { note: 'C#2', key: 'C#2', type: 'black' },
            { note: 'D2', key: 'D2', type: 'white', hasSharp: true }, { note: 'D#2', key: 'D#2', type: 'black' },
            { note: 'E2', key: 'E2', type: 'white', hasSharp: false },
            { note: 'F2', key: 'F2', type: 'white', hasSharp: true }, { note: 'F#2', key: 'F#2', type: 'black' },
            { note: 'G2', key: 'G2', type: 'white', hasSharp: true }, { note: 'G#2', key: 'G#2', type: 'black' },
            { note: 'A2', key: 'A2', type: 'white', hasSharp: true }, { note: 'A#2', key: 'A#2', type: 'black' },
            { note: 'B2', key: 'B2', type: 'white', hasSharp: false },
            // C3 (12 notas)
            { note: 'C3', key: 'Z', type: 'white', hasSharp: true }, { note: 'C#3', key: 'S', type: 'black' },
            { note: 'D3', key: 'X', type: 'white', hasSharp: true }, { note: 'D#3', key: 'D', type: 'black' },
            { note: 'E3', key: 'C', type: 'white', hasSharp: false },
            { note: 'F3', key: 'V', type: 'white', hasSharp: true }, { note: 'F#3', key: 'G', type: 'black' },
            { note: 'G3', key: 'B', type: 'white', hasSharp: true }, { note: 'G#3', key: 'H', type: 'black' },
            { note: 'A3', key: 'N', type: 'white', hasSharp: true }, { note: 'A#3', key: 'J', type: 'black' },
            { note: 'B3', key: 'M', type: 'white', hasSharp: false },
            // C4 (12 notas)
            { note: 'C4', key: 'A', type: 'white', hasSharp: true }, { note: 'C#4', key: 'W', type: 'black' },
            { note: 'D4', key: 'S', type: 'white', hasSharp: true }, { note: 'D#4', key: 'E', type: 'black' },
            { note: 'E4', key: 'D', type: 'white', hasSharp: false },
            { note: 'F4', key: 'F', type: 'white', hasSharp: true }, { note: 'F#4', key: 'T', type: 'black' },
            { note: 'G4', key: 'G', type: 'white', hasSharp: true }, { note: 'G#4', key: 'Y', type: 'black' },
            { note: 'A4', key: 'H', type: 'white', hasSharp: true }, { note: 'A#4', key: 'U', type: 'black' },
            { note: 'B4', key: 'J', type: 'white', hasSharp: false },
            // C5 (12 notas)
            { note: 'C5', key: 'K', type: 'white', hasSharp: true }, { note: 'C#5', key: 'O', type: 'black' },
            { note: 'D5', key: 'L', type: 'white', hasSharp: true }, { note: 'D#5', key: 'P', type: 'black' },
            { note: 'E5', key: ';', type: 'white', hasSharp: false },
            { note: 'F5', key: "'", type: 'white', hasSharp: true }, { note: 'F#5', key: '[', type: 'black' },
            { note: 'G5', key: ']', type: 'white', hasSharp: true }, { note: 'G#5', key: '-', type: 'black' },
            { note: 'A5', key: '=', type: 'white', hasSharp: true }, { note: 'A#5', key: '0', type: 'black' },
            { note: 'B5', key: '\\', type: 'white', hasSharp: false },
             // C6 (12 notas)
            { note: 'C6', key: '1', type: 'white', hasSharp: true }, { note: 'C#6', key: 'Q', type: 'black' },
            { note: 'D6', key: '2', type: 'white', hasSharp: true }, { note: 'D#6', key: 'R', type: 'black' },
            { note: 'E6', key: '3', type: 'white', hasSharp: false },
            { note: 'F6', key: 'T', type: 'white', hasSharp: true }, { note: 'F#6', key: '5', type: 'black' },
            { note: 'G6', key: 'G6', type: 'white', hasSharp: true }, { note: 'G#6', key: 'G#6', type: 'black' },
            { note: 'A6', key: 'A6', type: 'white', hasSharp: true }, { note: 'A#6', key: 'A#6', type: 'black' },
            { note: 'B6', key: 'B6', type: 'white', hasSharp: false },
            // C7 (7 notas - Fim do 5.5 oitavas)
            { note: 'C7', key: 'C7', type: 'white', hasSharp: true }, { note: 'C#7', key: 'C#7', type: 'black' },
            { note: 'D7', key: 'D7', type: 'white', hasSharp: true }, { note: 'D#7', key: 'D#7', type: 'black' },
            { note: 'E7', key: 'E7', type: 'white', hasSharp: false },
            { note: 'F7', key: 'F7', type: 'white', hasSharp: true }, { note: 'F#7', key: 'F#7', type: 'black' }
        ];

        // --- DEFINIÇÃO DOS 22 TIMBRES (PRESETS) ---
        const SYNTH_PRESETS = [
            { name: "01. Piano de Cauda Quente", voice: Tone.PolySynth, settings: { oscillator: { type: "amsine", modulationType: "triangle", frequency: 2, volume: -5 }, envelope: { attack: 0.005, decay: 0.8, sustain: 0.1, release: 1.5 } } },
            { name: "02. Rhodes Vintage", voice: Tone.PolySynth, settings: { oscillator: { type: "fmsine", modulationType: "square" }, envelope: { attack: 0.05, decay: 0.5, sustain: 0.2, release: 1.2 }, modulationIndex: 8, harmonicity: 0.5 } },
            { name: "03. Wurli Eletromecânico", voice: Tone.PolySynth, settings: { oscillator: { type: "amtriangle", modulationType: "sine" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.8 }, harmonicity: 2.5 } },
            { name: "04. Órgão de Jazz B3", voice: Tone.PolySynth, settings: { oscillator: { type: "triangle" }, envelope: { attack: 0.05, decay: 0.9, sustain: 1.0, release: 0.1 }, volume: -2 } },
            { name: "05. Cravo Barroco", voice: Tone.PolySynth, settings: { oscillator: { type: "sawtooth" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.2 }, volume: -4 } },
            { name: "06. Pad Ambient Flutuante", voice: Tone.PolySynth, settings: { oscillator: { type: "sine" }, envelope: { attack: 2.0, decay: 1.5, sustain: 0.8, release: 4.0 }, volume: -8 } },
            { name: "07. Lead Saw Gordinho", voice: Tone.PolySynth, settings: { oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.5, release: 1.0 }, detune: 5 } },
            { name: "08. Baixo Moog Sólido", voice: Tone.PolySynth, settings: { oscillator: { type: "square" }, envelope: { attack: 0.005, decay: 0.4, sustain: 0.3, release: 0.1 }, volume: -5 } },
            { name: "09. Arpeggio Pluck Curto", voice: Tone.PolySynth, settings: { oscillator: { type: "amtriangle" }, envelope: { attack: 0.002, decay: 0.1, sustain: 0, release: 0.15 } } },
            { name: "10. Sino DX7 FM", voice: Tone.PolySynth, settings: { oscillator: { type: "fmsine" }, envelope: { attack: 0.001, decay: 1.2, sustain: 0, release: 1.0 }, modulationIndex: 30, harmonicity: 0.5 } },
            { name: "11. Flauta de Madeira", voice: Tone.PolySynth, settings: { oscillator: { type: "sine" }, envelope: { attack: 0.15, decay: 0.3, sustain: 0.9, release: 1.5 }, volume: -4 } },
            { name: "12. Brass Quente (Synth)", voice: Tone.PolySynth, settings: { oscillator: { type: "sawtooth" }, envelope: { attack: 0.08, decay: 0.3, sustain: 0.5, release: 0.4 }, detune: -10 } },
            { name: "13. Acordeão (Harmônica)", voice: Tone.PolySynth, settings: { oscillator: { type: "sawtooth" }, envelope: { attack: 0.05, decay: 0.5, sustain: 0.8, release: 0.5 }, detune: 10 } },
            { name: "14. Strings Clássicas (Pad)", voice: Tone.PolySynth, settings: { oscillator: { type: "triangle" }, envelope: { attack: 0.8, decay: 1.0, sustain: 0.9, release: 3.0 }, volume: -6 } },
            { name: "15. Pincel Sonora (Swash)", voice: Tone.PolySynth, settings: { oscillator: { type: "square", volume: -10 }, envelope: { attack: 0.2, decay: 0.1, sustain: 0.7, release: 2.0 } } },
            { name: "16. Ruído Clicável", voice: Tone.PolySynth, settings: { oscillator: { type: "square" }, envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.05 } } },
            { name: "17. Onda Senoidal Pura", voice: Tone.PolySynth, settings: { oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.4, release: 0.8 } } },
            { name: "18. Square Wave 8-bit", voice: Tone.PolySynth, settings: { oscillator: { type: "square" }, envelope: { attack: 0.005, decay: 0.2, sustain: 0.5, release: 0.5 } } },
            { name: "19. Steel Drum Caribenho", voice: Tone.PolySynth, settings: { oscillator: { type: "fmsine" }, envelope: { attack: 0.005, decay: 0.3, sustain: 0.1, release: 0.4 }, modulationIndex: 50, harmonicity: 0.5 } },
            { name: "20. Toy Piano Percussivo", voice: Tone.PolySynth, settings: { oscillator: { type: "amtriangle" }, envelope: { attack: 0.001, decay: 0.1, sustain: 0.01, release: 0.2 } } },
            { name: "21. Vibrafone Mellow", voice: Tone.PolySynth, settings: { oscillator: { type: "fmsine" }, envelope: { attack: 0.05, decay: 0.8, sustain: 0.01, release: 1.0 }, modulationIndex: 12, harmonicity: 0.8 } },
            { name: "22. Sub Bass Profundo", voice: Tone.PolySynth, settings: { oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.8, release: 0.5 }, volume: -10 } },
        ];


        // --- VARIÁVEIS GLOBAIS DE ÁUDIO ---
        let initializedSynths = [];
        let currentTimbreIndex = 0;
        let currentSynth = null;
        let isReady = false;
        const activeKeys = new Set();
        const NOTE_BY_KEY = {};
        Object.keys(KEY_TO_NOTE).forEach(key => NOTE_BY_KEY[key] = KEY_TO_NOTE[key]);

        // Efeitos globais (Knobs)
        let masterTremolo = new Tone.Tremolo(9, 0.75).set({ wet: 0.0 }).start();
        let masterChorus = new Tone.Chorus(4, 2.5, 0.5).set({ wet: 0.0 });
        let masterDistortion = new Tone.Distortion(0.0).set({ wet: 0.0 });
        let masterReverb = new Tone.Reverb({ decay: 3, wet: 0.5 }).set({ wet: 0.5 }); 

        // Cadeia de Efeitos: Synth -> Tremolo -> Chorus -> Distortion -> Reverb -> Destination
        masterTremolo.connect(masterChorus);
        masterChorus.connect(masterDistortion);
        masterDistortion.connect(masterReverb);
        masterReverb.toDestination();


        /**
         * Inicializa a cadeia de áudio e todos os presets.
         */
        function initializeAudio() {
            if (isReady) return;

            // 1. Inicializa todos os Synths
            initializedSynths = SYNTH_PRESETS.map(preset => {
                const SynthType = preset.voice || Tone.PolySynth;
                let synth = new SynthType(Tone.Synth, preset.settings);

                // Conecta todos os synths ao início da cadeia de efeitos (Tremolo)
                synth.connect(masterTremolo);
                synth.volume.value = -Infinity; // Muta inicialmente
                return synth;
            });

            // 2. Define o primeiro synth como ativo
            currentSynth = initializedSynths[currentTimbreIndex];
            currentSynth.volume.value = 0; // Liga o volume

            isReady = true;
            console.log("Sistema de Áudio e 22 Timbres Inicializados.");
            document.getElementById('loading-overlay').classList.add('opacity-0', 'pointer-events-none');
            
            // Atualiza o painel e os knobs
            updateControlPanel();
            updateKnobVisuals();
        }

        /**
         * Toca uma nota e aplica o estilo ativo.
         */
        function playNote(note) {
            if (!isReady || activeKeys.has(note)) return;

            try {
                currentSynth.triggerAttack(note);
                activeKeys.add(note);

                const keyElement = document.querySelector(`[data-note="${note}"]`);
                if (keyElement) {
                    keyElement.classList.add('key-active');
                }
            } catch (e) {
                console.error("Erro ao tocar nota:", e);
            }
        }

        /**
         * Para uma nota e remove o estilo ativo.
         */
        function stopNote(note) {
            if (!isReady) return;

            try {
                currentSynth.triggerRelease(note);
                activeKeys.delete(note);

                const keyElement = document.querySelector(`[data-note="${note}"]`);
                if (keyElement) {
                    keyElement.classList.remove('key-active');
                }
            } catch (e) {
                console.error("Erro ao parar nota:", e);
            }
        }

        /**
         * Alterna para o próximo timbre na lista.
         */
        function changeTimbre(direction) {
            if (!isReady) return;

            if (currentSynth) {
                currentSynth.volume.value = -Infinity; 
            }

            currentTimbreIndex += direction;
            if (currentTimbreIndex >= SYNTH_PRESETS.length) {
                currentTimbreIndex = 0;
            } else if (currentTimbreIndex < 0) {
                currentTimbreIndex = SYNTH_PRESETS.length - 1;
            }

            currentSynth = initializedSynths[currentTimbreIndex];
            currentSynth.volume.value = 0; 
            
            updateControlPanel();
        }
        
        /**
         * Atualiza o painel visual com o nome do timbre e índice.
         */
        function updateControlPanel() {
            const displayElement = document.getElementById('current-timbre-display');
            if (displayElement) {
                const preset = SYNTH_PRESETS[currentTimbreIndex];
                const presetName = `${preset.name}`.padEnd(30, ' ');
                displayElement.textContent = presetName.substring(0, 30);
            }
        }

        /**
         * Constrói o elemento HTML de uma tecla do piano. 
         */
        function createKeyElement(keyData) {
            const isWhite = keyData.type === 'white';
            const element = document.createElement('div');
            element.classList.add('piano-key');
            element.classList.add(isWhite ? 'white-key' : 'black-key');
            element.setAttribute('data-note', keyData.note);
            // Só adiciona o data-key se houver um mapeamento real (para o teclado físico)
            const mappedKey = KEY_TO_NOTE[keyData.key.toLowerCase()];
            if(mappedKey) {
                element.setAttribute('data-key', keyData.key.toLowerCase());
            }

            const keyTextContainer = document.createElement('div');
            keyTextContainer.classList.add('key-text', 'absolute', 'w-full');
            keyTextContainer.classList.add(isWhite ? 'bottom-2' : 'bottom-1');

            const noteLabel = document.createElement('div');
            noteLabel.classList.add('note-label', 'text-xs');
            noteLabel.textContent = keyData.note.replace(/[0-9]/g, ''); 
            
            const octaveLabel = document.createElement('div');
            octaveLabel.classList.add('note-label', 'text-xs');
            octaveLabel.textContent = keyData.note.replace(/[^0-9]/g, ''); 

            const keyLabel = document.createElement('div');
            keyLabel.classList.add('key-label', 'font-extrabold');
            // Mostra o mapeamento do teclado físico (se existir) ou a nota/oitava para as teclas não mapeadas.
            keyLabel.textContent = mappedKey ? keyData.key : keyData.note.substring(0, keyData.note.length - 1);
            
            keyTextContainer.appendChild(keyLabel);
            keyTextContainer.appendChild(noteLabel);
            keyTextContainer.appendChild(octaveLabel);
            
            element.appendChild(keyTextContainer);
            
            if (!isWhite) {
                 return element;
            }

            const keyContainer = document.createElement('div');
            keyContainer.classList.add('key-container');
            keyContainer.appendChild(element);
            return keyContainer;
        }

        /**
         * Renderiza o piano completo no DOM. 
         */
        function renderPiano() {
            const pianoContainer = document.getElementById('piano');
            if (!pianoContainer) return;
            
            pianoContainer.innerHTML = '';
            let currentOctaveGroup = null;
            let currentOctave = 2;

            NOTES_SEQUENCE.forEach((keyData, index) => {
                const octaveMatch = keyData.note.match(/(\d)/);
                const currentNoteOctave = octaveMatch ? parseInt(octaveMatch[1]) : 2;

                if (currentNoteOctave !== currentOctave || keyData.note.startsWith('C')) {
                    if (currentOctaveGroup) {
                        pianoContainer.appendChild(currentOctaveGroup);
                    }
                    currentOctaveGroup = document.createElement('div');
                    currentOctaveGroup.classList.add('octave-group', 'flex');
                    currentOctave = currentNoteOctave;
                }
                
                const isWhite = keyData.type === 'white';

                if (isWhite) {
                    const whiteKeyContainer = createKeyElement(keyData); 

                    // Verifica se a próxima nota é preta e, se for, a aninha (índice + 1)
                    if (keyData.hasSharp && NOTES_SEQUENCE[index + 1] && NOTES_SEQUENCE[index + 1].type === 'black') {
                        const blackKeyData = NOTES_SEQUENCE[index + 1];
                        const blackKeyElement = createKeyElement(blackKeyData); 
                        
                        whiteKeyContainer.appendChild(blackKeyElement); 
                    }

                    if (currentOctaveGroup) {
                        currentOctaveGroup.appendChild(whiteKeyContainer);
                    }
                }
            });

            // Adiciona o último grupo
            if (currentOctaveGroup) {
                pianoContainer.appendChild(currentOctaveGroup);
            }
        }
        
        /**
         * Controla a lógica de arraste do Knob.
         */
        function setupKnobControl(knobElement, effect, initialValue) {
            const marker = knobElement.querySelector('.knob-marker');
            let isDragging = false;
            const minVal = parseFloat(knobElement.getAttribute('data-min'));
            const maxVal = parseFloat(knobElement.getAttribute('data-max'));
            let currentValue = initialValue;

            const getAngle = (value) => {
                const range = maxVal - minVal;
                const normalized = (value - minVal) / range; 
                return -135 + (normalized * 270); 
            };

            const updateEffect = (newValue) => {
                newValue = Math.max(minVal, Math.min(maxVal, newValue));
                currentValue = parseFloat(newValue.toFixed(2));
                
                switch (effect) {
                    case 'reverb':
                        masterReverb.set({ wet: currentValue });
                        break;
                    case 'chorus':
                        masterChorus.set({ wet: currentValue });
                        break;
                    case 'tremolo':
                        masterTremolo.set({ wet: currentValue });
                        break;
                    case 'drive':
                        masterDistortion.set({ distortion: currentValue });
                        break;
                }
                
                marker.style.transform = `rotate(${getAngle(currentValue)}deg)`;
                knobElement.setAttribute('data-value', currentValue);
            };

            updateEffect(currentValue);

            const startDrag = (e) => {
                e.preventDefault();
                isDragging = true;
                knobElement.style.cursor = 'ns-resize'; 
            };

            const doDrag = (e) => {
                if (!isDragging) return;
                
                const step = 0.01 * (maxVal / 1); 
                const delta = -e.movementY * step; 

                let newValue = currentValue + delta;
                updateEffect(newValue);
            };

            const endDrag = () => {
                if (isDragging) {
                    isDragging = false;
                    knobElement.style.cursor = 'pointer';
                }
            };

            knobElement.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', endDrag);

            // Suporte a toque (touch)
            knobElement.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDragging = true;
                knobElement._lastY = e.touches[0].clientY;
            });

            document.addEventListener('touchmove', (e) => {
                if (!isDragging || e.touches.length === 0) return;
                
                const touch = e.touches[0];
                if (knobElement._lastY === undefined) {
                     knobElement._lastY = touch.clientY;
                }
                const movementY = touch.clientY - knobElement._lastY;
                knobElement._lastY = touch.clientY;

                const step = 0.01 * (maxVal / 1);
                // Invertido para se ajustar ao movimento de arrasto em telas touch
                const delta = movementY * step * 2; 
                let newValue = currentValue - delta;
                updateEffect(newValue);
            });

            document.addEventListener('touchend', endDrag);
            document.addEventListener('touchcancel', endDrag);
        }

        /**
         * Configura todos os knobs.
         */
        function setupAllKnobs() {
            setupKnobControl(document.getElementById('knob-reverb'), 'reverb', masterReverb.wet.value);
            setupKnobControl(document.getElementById('knob-chorus'), 'chorus', masterChorus.wet.value);
            setupKnobControl(document.getElementById('knob-tremolo'), 'tremolo', masterTremolo.wet.value);
            setupKnobControl(document.getElementById('knob-drive'), 'drive', masterDistortion.distortion);
        }

        /**
         * Atualiza a posição visual de todos os knobs.
         */
        function updateKnobVisuals() {
             setupAllKnobs();
        }

        // --- Eventos de Interação ---

        // Evento de pressionar tecla
        document.addEventListener('keydown', (event) => {
            const key = event.key.toLowerCase();
            const note = KEY_TO_NOTE[key];

            if (note && !event.repeat) {
                if (key === ' ' && event.target === document.body) {
                    event.preventDefault(); 
                }
                playNote(note);
            } else if ((event.key === 'Insert' || event.keyCode === 45) && !event.repeat) {
                changeTimbre(1);
            }
        });

        // Evento de soltar tecla
        document.addEventListener('keyup', (event) => {
            const key = event.key.toLowerCase();
            const note = KEY_TO_NOTE[key];

            if (note) {
                stopNote(note);
            }
        });

        // Eventos de mouse (clique/toque)
        const pianoElement = document.getElementById('piano');
        let notePlayedByMouse = null; // Rastreia a nota iniciada pelo clique

        if (pianoElement) {
             pianoElement.addEventListener('mousedown', (event) => {
                if (Tone.context.state !== 'running') {
                    Tone.start().then(initializeAudio);
                } else if (!isReady) {
                    initializeAudio();
                }

                // Busca a tecla mais próxima, seja ela branca ou preta
                const keyElement = event.target.closest('.piano-key');
                if (keyElement) {
                    const note = keyElement.getAttribute('data-note');
                    playNote(note);
                    notePlayedByMouse = note; // Salva a nota iniciada
                }
            });

            // Mouseup para liberar a nota. 
            // Usa 'notePlayedByMouse' para garantir que a nota correta seja parada, 
            // mesmo que o mouse saia ligeiramente da tecla.
            document.addEventListener('mouseup', () => {
                if (notePlayedByMouse) {
                    stopNote(notePlayedByMouse);
                    notePlayedByMouse = null;
                }
            });
            
             // Garante que o som para ao sair da área (para evitar notas presas)
            pianoElement.addEventListener('mouseleave', () => {
                if (notePlayedByMouse) {
                    stopNote(notePlayedByMouse);
                    notePlayedByMouse = null;
                }
            });


            // Adiciona suporte a toque
            pianoElement.addEventListener('touchstart', (event) => {
                event.preventDefault(); 
                if (Tone.context.state !== 'running') {
                    Tone.start().then(initializeAudio);
                } else if (!isReady) {
                    initializeAudio();
                }
                
                // Mapeia todos os toques ativos para notas
                Array.from(event.touches).forEach(touch => {
                    const keyElement = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.piano-key');
                    if (keyElement) {
                        const note = keyElement.getAttribute('data-note');
                        playNote(note);
                    }
                });
            }, { passive: false });

            pianoElement.addEventListener('touchend', (event) => {
                event.preventDefault();
                // Simplesmente para todas as notas ativas que foram tocadas (comum em touch)
                activeKeys.forEach(note => stopNote(note));
            });
        }
        
        // Inicia o contexto de áudio no primeiro clique no corpo do documento
        document.body.addEventListener('click', () => {
            if (Tone.context.state !== 'running') {
                Tone.start().then(initializeAudio); 
            } else if (!isReady) {
                initializeAudio();
            }
        }, { once: true });


        // Inicialização: Renderiza a UI do piano
        window.onload = () => {
            renderPiano();
            setupAllKnobs(); 
        };
    </script>
</body>
</html>
