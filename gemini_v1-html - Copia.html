<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Interativo (C3 a C6 - Timbres e Efeitos)</title>
    <!-- Carrega Tailwind CSS para estilização responsiva -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.min.js"></script>
    <!-- Carrega a biblioteca Tone.js -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos Customizados do Piano */
        .piano-key {
            transition: background-color 0.05s ease, transform 0.05s ease;
            cursor: pointer;
            user-select: none;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            font-weight: 500;
        }

        .white-key {
            width: 50px; 
            height: 200px;
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-top: none; 
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            margin-right: 2px;
            z-index: 1;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .black-key {
            width: 30px;
            height: 130px;
            background-color: #1f2937;
            border-radius: 0 0 4px 4px;
            position: absolute;
            top: 0;
            left: -15px; 
            z-index: 2;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6);
            border: 1px solid #000;
        }

        .key-active.white-key {
            background-color: #ffe0b2;
            transform: translateY(2px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
        }

        .key-active.black-key {
            background-color: #0d1218; 
            transform: translateY(2px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
        }

        .octave-group {
            display: flex;
            margin-right: 4px; 
        }
        .key-container {
            position: relative;
            flex-grow: 0; 
        }
        
        /* Estilo Específico para o LCD */
        .lcd-display {
            background-color: #1d352b; /* Fundo verde escuro (retro) */
            color: #b8f1c4; /* Fonte verde claro (pixel) */
            font-family: 'monospace', 'Courier New', Courier;
            border: 3px solid #0f172a;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
        }

        /* Estilo do Knob (simulação visual) */
        .knob {
            width: 40px;
            height: 40px;
            background: linear-gradient(to top, #374151, #1f2937);
            border-radius: 50%;
            border: 2px solid #6b7280;
            position: relative;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5), inset 0 0 8px rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .knob-marker {
            position: absolute;
            top: 2px;
            width: 4px;
            height: 15px;
            background-color: #ef4444; /* Vermelho vibrante */
            border-radius: 2px;
            transform-origin: center 18px; /* Ponto de rotação no centro inferior do marcador */
        }
        
        /* Responsividade para telas menores */
        @media (max-width: 640px) {
            .white-key { width: 35px; height: 150px; }
            .black-key { width: 20px; height: 100px; left: -10px; }
            .octave-group { margin-right: 2px; }
            .knob { width: 30px; height: 30px; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Overlay de Início de Áudio -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900/90 flex items-center justify-center z-50 transition-opacity duration-500">
        <div class="text-xl font-semibold text-white p-6 bg-gray-800 rounded-lg shadow-2xl animate-pulse">
            Clique em qualquer lugar para carregar os timbres e começar a tocar.
        </div>
    </div>

    <div class="w-full max-w-7xl mx-auto p-4 bg-gray-200 rounded-xl shadow-2xl border-b-8 border-gray-400">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-4 text-center">
            Piano Digital Interativo (C3 a C6)
        </h1>
        
        <!-- PAINEL DE CONTROLE (Visual de Instrumento Aprimorado) -->
        <div id="control-panel" class="mb-6 p-4 bg-gray-800 rounded-lg shadow-inner text-white flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
            
            <!-- LCD Display para Timbre Atual -->
            <div class="w-full md:w-1/3 text-left">
                <p class="text-sm font-light text-gray-400 mb-1">Timbre Atual:</p>
                <div class="lcd-display rounded-lg">
                    <p id="current-timbre-display" class="text-2xl font-mono font-bold whitespace-nowrap overflow-hidden">Carregando...</p>
                </div>
            </div>

            <!-- Knobs de Efeitos -->
            <div class="flex flex-wrap justify-center space-x-4">
                <!-- Knob 1: Reverb -->
                <div class="flex flex-col items-center">
                    <div id="knob-reverb" class="knob" data-effect="reverb" data-value="0.5" data-min="0" data-max="1">
                        <div class="knob-marker" style="transform: rotate(-45deg);"></div>
                    </div>
                    <p class="text-xs mt-1 text-gray-400">REVERB</p>
                </div>
                
                <!-- Knob 2: Chorus -->
                <div class="flex flex-col items-center">
                    <div id="knob-chorus" class="knob" data-effect="chorus" data-value="0.0" data-min="0" data-max="1">
                        <div class="knob-marker" style="transform: rotate(-135deg);"></div>
                    </div>
                    <p class="text-xs mt-1 text-gray-400">CHORUS</p>
                </div>
                
                <!-- Knob 3: Tremolo -->
                <div class="flex flex-col items-center">
                    <div id="knob-tremolo" class="knob" data-effect="tremolo" data-value="0.0" data-min="0" data-max="1">
                        <div class="knob-marker" style="transform: rotate(-135deg);"></div>
                    </div>
                    <p class="text-xs mt-1 text-gray-400">TREMOLO</p>
                </div>
                
                <!-- Knob 4: Drive -->
                <div class="flex flex-col items-center">
                    <div id="knob-drive" class="knob" data-effect="drive" data-value="0.0" data-min="0" data-max="0.8">
                        <div class="knob-marker" style="transform: rotate(-135deg);"></div>
                    </div>
                    <p class="text-xs mt-1 text-gray-400">DRIVE</p>
                </div>
            </div>

            <!-- Instrução INSERT -->
            <div class="w-full md:w-auto text-center md:text-right">
                <p class="text-sm font-light text-gray-400">Trocar Timbre (22 Presets):</p>
                <div class="flex items-center justify-center md:justify-end space-x-2 mt-1">
                    <span class="text-lg font-bold bg-gray-700 py-1 px-3 rounded-md shadow-md">INSERT</span>
                    <span class="text-base text-gray-400">próximo</span>
                </div>
            </div>
        </div>
        
        <!-- Container do Piano (com scroll horizontal) -->
        <div id="piano" class="flex justify-center overflow-x-auto p-2 bg-gray-900 rounded-lg shadow-inner border-b-4 border-gray-700">
            <!-- O Piano será renderizado aqui -->
        </div>

        <!-- Legenda do Mapeamento de Teclas -->
        <div class="mt-8 p-4 bg-gray-50 rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-gray-700 mb-3 text-center">Mapeamento de Teclado (PC)</h2>
            <p class="text-center text-gray-600 text-sm">
                **C3-B3:** (Linha inferior) Z, S, X, D, C, V, G, B, H, N, J, M | 
                **C4-B4:** (Linha do meio) A, W, S, E, D, F, T, G, Y, H, U, J |
                **C5-C6:** (Linha superior) K, O, L, P, Ç, [ , ], -
            </p>
        </div>
    </div>

    <script type="module">
        // --- DADOS DO PIANO E TECLADO (C3 a C6) ---
        // Mapeamento otimizado para a digitação
        const KEY_TO_NOTE = {
            // Oitava 3 (Z-M)
            'z': 'C3', 's': 'C#3', 'x': 'D3', 'd': 'D#3', 'c': 'E3',
            'v': 'F3', 'g': 'F#3', 'b': 'G3', 'h': 'G#3', 'n': 'A3', 'j': 'A#3', 'm': 'B3',
            // Oitava 4 (A-J)
            'a': 'C4', 'w': 'C#4', 's': 'D4', 'e': 'D#4', 'd': 'E4',
            'f': 'F4', 't': 'F#4', 'g': 'G4', 'y': 'G#4', 'h': 'A4', 'u': 'A#4', 'j': 'B4',
            // Oitava 5 (K-Ç)
            'k': 'C5', 'o': 'C#5', 'l': 'D5', 'p': 'D#5', ';': 'E5',
            '\'': 'F5', '[': 'F#5', ']': 'G5', '-': 'G#5', 
            // Teclas adicionais para A5, A#5, B5, C6 (Perto do Enter/Backspace)
            'p': 'A5', '0': 'A#5', '=': 'B5', '\\': 'C6' 
        };

        // Estrutura das teclas para renderização da interface
        const NOTES_SEQUENCE = [
            // C3 (12 notas)
            { note: 'C3', key: 'Z', type: 'white', hasSharp: true }, { note: 'C#3', key: 'S', type: 'black' },
            { note: 'D3', key: 'X', type: 'white', hasSharp: true }, { note: 'D#3', key: 'D', type: 'black' },
            { note: 'E3', key: 'C', type: 'white', hasSharp: false },
            { note: 'F3', key: 'V', type: 'white', hasSharp: true }, { note: 'F#3', key: 'G', type: 'black' },
            { note: 'G3', key: 'B', type: 'white', hasSharp: true }, { note: 'G#3', key: 'H', type: 'black' },
            { note: 'A3', key: 'N', type: 'white', hasSharp: true }, { note: 'A#3', key: 'J', type: 'black' },
            { note: 'B3', key: 'M', type: 'white', hasSharp: false },
            // C4 (12 notas)
            { note: 'C4', key: 'A', type: 'white', hasSharp: true }, { note: 'C#4', key: 'W', type: 'black' },
            { note: 'D4', key: 'S', type: 'white', hasSharp: true }, { note: 'D#4', key: 'E', type: 'black' },
            { note: 'E4', key: 'D', type: 'white', hasSharp: false },
            { note: 'F4', key: 'F', type: 'white', hasSharp: true }, { note: 'F#4', key: 'T', type: 'black' },
            { note: 'G4', key: 'G', type: 'white', hasSharp: true }, { note: 'G#4', key: 'Y', type: 'black' },
            { note: 'A4', key: 'H', type: 'white', hasSharp: true }, { note: 'A#4', key: 'U', type: 'black' },
            { note: 'B4', key: 'J', type: 'white', hasSharp: false },
            // C5 (12 notas)
            { note: 'C5', key: 'K', type: 'white', hasSharp: true }, { note: 'C#5', key: 'O', type: 'black' },
            { note: 'D5', key: 'L', type: 'white', hasSharp: true }, { note: 'D#5', key: 'P', type: 'black' },
            { note: 'E5', key: ';', type: 'white', hasSharp: false },
            { note: 'F5', key: "'", type: 'white', hasSharp: true }, { note: 'F#5', key: '[', type: 'black' },
            { note: 'G5', key: ']', type: 'white', hasSharp: true }, { note: 'G#5', key: '-', type: 'black' },
            { note: 'A5', key: '0', type: 'white', hasSharp: true }, { note: 'A#5', key: '=', type: 'black' },
            { note: 'B5', key: '\\', type: 'white', hasSharp: false },
            // C6 (1 nota)
            { note: 'C6', key: '/', type: 'white', hasSharp: false }
        ];

        // --- DEFINIÇÃO DOS 22 TIMBRES (PRESETS) APRIMORADOS ---
        const SYNTH_PRESETS = [
            // Sons de Piano/Teclado Clássico (Mais orgânicos)
            { name: "01. Piano de Cauda Quente", voice: Tone.PolySynth, settings: { oscillator: { type: "amsine", modulationType: "triangle", frequency: 2, volume: -5 }, envelope: { attack: 0.005, decay: 0.8, sustain: 0.1, release: 1.5 } } },
            { name: "02. Rhodes Vintage", voice: Tone.PolySynth, settings: { oscillator: { type: "fmsine", modulationType: "square" }, envelope: { attack: 0.05, decay: 0.5, sustain: 0.2, release: 1.2 }, modulationIndex: 8, harmonicity: 0.5 } },
            { name: "03. Wurli Eletromecânico", voice: Tone.PolySynth, settings: { oscillator: { type: "amtriangle", modulationType: "sine" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.8 }, harmonicity: 2.5 } },
            { name: "04. Órgão de Jazz B3", voice: Tone.PolySynth, settings: { oscillator: { type: "triangle" }, envelope: { attack: 0.05, decay: 0.9, sustain: 1.0, release: 0.1 }, volume: -2 } },
            { name: "05. Cravo Barroco", voice: Tone.PolySynth, settings: { oscillator: { type: "sawtooth" }, envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.2 }, volume: -4 } },
            // Timbres de Synth (Ricos)
            { name: "06. Pad Ambient Flutuante", voice: Tone.PolySynth, settings: { oscillator: { type: "sine" }, envelope: { attack: 2.0, decay: 1.5, sustain: 0.8, release: 4.0 }, volume: -8 } },
            { name: "07. Lead Saw Gordinho", voice: Tone.PolySynth, settings: { oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.5, release: 1.0 }, detune: 5 } },
            { name: "08. Baixo Moog Sólido", voice: Tone.PolySynth, settings: { oscillator: { type: "square" }, envelope: { attack: 0.005, decay: 0.4, sustain: 0.3, release: 0.1 }, volume: -5 } },
            { name: "09. Arpeggio Pluck Curto", voice: Tone.PolySynth, settings: { oscillator: { type: "amtriangle" }, envelope: { attack: 0.002, decay: 0.1, sustain: 0, release: 0.15 } } },
            { name: "10. Sino DX7 FM", voice: Tone.PolySynth, settings: { oscillator: { type: "fmsine" }, envelope: { attack: 0.001, decay: 1.2, sustain: 0, release: 1.0 }, modulationIndex: 30, harmonicity: 0.5 } },
            // Instrumentos Melódicos
            { name: "11. Flauta de Madeira", voice: Tone.PolySynth, settings: { oscillator: { type: "sine" }, envelope: { attack: 0.15, decay: 0.3, sustain: 0.9, release: 1.5 }, volume: -4 } },
            { name: "12. Brass Quente (Synth)", voice: Tone.PolySynth, settings: { oscillator: { type: "sawtooth" }, envelope: { attack: 0.08, decay: 0.3, sustain: 0.5, release: 0.4 }, detune: -10 } },
            { name: "13. Acordeão (Harmônica)", voice: Tone.PolySynth, settings: { oscillator: { type: "sawtooth" }, envelope: { attack: 0.05, decay: 0.5, sustain: 0.8, release: 0.5 }, detune: 10 } },
            { name: "14. Strings Clássicas (Pad)", voice: Tone.PolySynth, settings: { oscillator: { type: "triangle" }, envelope: { attack: 0.8, decay: 1.0, sustain: 0.9, release: 3.0 }, volume: -6 } },
            { name: "15. Pincel Sonora (Swash)", voice: Tone.PolySynth, settings: { oscillator: { type: "square", volume: -10 }, envelope: { attack: 0.2, decay: 0.1, sustain: 0.7, release: 2.0 } } },
            // Timbres Experimentais (FIXED: Preset 16 now uses 'square' instead of invalid 'noise')
            { name: "16. Ruído Clicável", voice: Tone.PolySynth, settings: { oscillator: { type: "square" }, envelope: { attack: 0.001, decay: 0.05, sustain: 0, release: 0.05 } } },
            { name: "17. Onda Senoidal Pura", voice: Tone.PolySynth, settings: { oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.4, release: 0.8 } } },
            { name: "18. Square Wave 8-bit", voice: Tone.PolySynth, settings: { oscillator: { type: "square" }, envelope: { attack: 0.005, decay: 0.2, sustain: 0.5, release: 0.5 } } },
            { name: "19. Steel Drum Caribenho", voice: Tone.PolySynth, settings: { oscillator: { type: "fmsine" }, envelope: { attack: 0.005, decay: 0.3, sustain: 0.1, release: 0.4 }, modulationIndex: 50, harmonicity: 0.5 } },
            { name: "20. Toy Piano Percussivo", voice: Tone.PolySynth, settings: { oscillator: { type: "amtriangle" }, envelope: { attack: 0.001, decay: 0.1, sustain: 0.01, release: 0.2 } } },
            { name: "21. Vibrafone Mellow", voice: Tone.PolySynth, settings: { oscillator: { type: "fmsine" }, envelope: { attack: 0.05, decay: 0.8, sustain: 0.01, release: 1.0 }, modulationIndex: 12, harmonicity: 0.8 } },
            { name: "22. Sub Bass Profundo", voice: Tone.PolySynth, settings: { oscillator: { type: "sine" }, envelope: { attack: 0.01, decay: 0.5, sustain: 0.8, release: 0.5 }, volume: -10 } },
        ];


        // --- VARIÁVEIS GLOBAIS DE ÁUDIO ---
        let initializedSynths = [];
        let currentTimbreIndex = 0;
        let currentSynth = null;
        let isReady = false;
        const activeKeys = new Set();
        const NOTE_BY_KEY = {};
        Object.keys(KEY_TO_NOTE).forEach(key => NOTE_BY_KEY[key] = KEY_TO_NOTE[key]);

        // Efeitos globais (Knobs)
        let masterTremolo = new Tone.Tremolo(9, 0.75).set({ wet: 0.0 }).start();
        let masterChorus = new Tone.Chorus(4, 2.5, 0.5).set({ wet: 0.0 });
        let masterDistortion = new Tone.Distortion(0.0).set({ wet: 0.0 });
        let masterReverb = new Tone.Reverb({ decay: 3, wet: 0.5 }).set({ wet: 0.5 }); // Inicia com wet de 0.5 no preset

        // Cadeia de Efeitos: Synth -> Tremolo -> Chorus -> Distortion -> Reverb -> Destination
        masterTremolo.connect(masterChorus);
        masterChorus.connect(masterDistortion);
        masterDistortion.connect(masterReverb);
        masterReverb.toDestination();


        /**
         * Inicializa a cadeia de áudio e todos os presets.
         */
        function initializeAudio() {
            if (isReady) return;

            // 1. Inicializa todos os Synths
            initializedSynths = SYNTH_PRESETS.map(preset => {
                const SynthType = preset.voice || Tone.PolySynth;
                let synth = new SynthType(Tone.Synth, preset.settings);

                // Conecta todos os synths ao início da cadeia de efeitos (Tremolo)
                synth.connect(masterTremolo);
                synth.volume.value = -Infinity; // Muta inicialmente
                return synth;
            });

            // 2. Define o primeiro synth como ativo
            currentSynth = initializedSynths[currentTimbreIndex];
            currentSynth.volume.value = 0; // Liga o volume

            isReady = true;
            console.log("Sistema de Áudio e 22 Timbres Inicializados.");
            document.getElementById('loading-overlay').classList.add('opacity-0', 'pointer-events-none');
            
            // Atualiza o painel e os knobs
            updateControlPanel();
            updateKnobVisuals();
        }

        /**
         * Toca uma nota e aplica o estilo ativo.
         */
        function playNote(note) {
            if (!isReady || activeKeys.has(note)) return;

            try {
                currentSynth.triggerAttack(note);
                activeKeys.add(note);

                const keyElement = document.querySelector(`[data-note="${note}"]`);
                if (keyElement) {
                    keyElement.classList.add('key-active');
                }
            } catch (e) {
                console.error("Erro ao tocar nota:", e);
            }
        }

        /**
         * Para uma nota e remove o estilo ativo.
         */
        function stopNote(note) {
            if (!isReady) return;

            try {
                currentSynth.triggerRelease(note);
                activeKeys.delete(note);

                const keyElement = document.querySelector(`[data-note="${note}"]`);
                if (keyElement) {
                    keyElement.classList.remove('key-active');
                }
            } catch (e) {
                console.error("Erro ao parar nota:", e);
            }
        }

        /**
         * Alterna para o próximo timbre na lista.
         */
        function changeTimbre(direction) {
            if (!isReady) return;

            // Muta o synth atual
            if (currentSynth) {
                currentSynth.volume.value = -Infinity; 
            }

            // Calcula o novo índice (ciclando)
            currentTimbreIndex += direction;
            if (currentTimbreIndex >= SYNTH_PRESETS.length) {
                currentTimbreIndex = 0;
            } else if (currentTimbreIndex < 0) {
                currentTimbreIndex = SYNTH_PRESETS.length - 1;
            }

            // Define o novo synth e liga o volume
            currentSynth = initializedSynths[currentTimbreIndex];
            currentSynth.volume.value = 0; 
            
            updateControlPanel();
        }
        
        /**
         * Atualiza o painel visual com o nome do timbre e índice.
         */
        function updateControlPanel() {
            const displayElement = document.getElementById('current-timbre-display');
            if (displayElement) {
                const preset = SYNTH_PRESETS[currentTimbreIndex];
                // Formata com índice e padding para preencher o "LCD"
                const presetName = `${preset.name}`.padEnd(30, ' ');
                displayElement.textContent = presetName.substring(0, 30);
            }
        }

        /**
         * Constrói o elemento HTML de uma tecla do piano. (Função de renderização da V3)
         */
        function createKeyElement(keyData) {
            const isWhite = keyData.type === 'white';
            const element = document.createElement('div');
            element.classList.add('piano-key');
            element.classList.add(isWhite ? 'white-key' : 'black-key');
            element.setAttribute('data-note', keyData.note);
            element.setAttribute('data-key', keyData.key.toLowerCase());

            const keyTextContainer = document.createElement('div');
            keyTextContainer.classList.add('key-text', 'absolute', 'w-full');
            keyTextContainer.classList.add(isWhite ? 'bottom-2' : 'bottom-1');

            const noteLabel = document.createElement('div');
            noteLabel.classList.add('note-label', 'text-xs');
            noteLabel.textContent = keyData.note.replace(/[0-9]/g, ''); // Apenas nota
            
            const octaveLabel = document.createElement('div');
            octaveLabel.classList.add('note-label', 'text-xs');
            octaveLabel.textContent = keyData.note.replace(/[^0-9]/g, ''); // Apenas oitava

            const keyLabel = document.createElement('div');
            keyLabel.classList.add('key-label', 'text-xl', 'font-extrabold');
            keyLabel.textContent = keyData.key;
            
            keyTextContainer.appendChild(keyLabel);
            keyTextContainer.appendChild(noteLabel);
            keyTextContainer.appendChild(octaveLabel);
            
            element.appendChild(keyTextContainer);
            
            if (!isWhite) {
                 return element;
            }

            const keyContainer = document.createElement('div');
            keyContainer.classList.add('key-container');
            keyContainer.appendChild(element);
            return keyContainer;
        }

        /**
         * Renderiza o piano completo no DOM, agrupando por oitavas. (Função de renderização da V3)
         */
        function renderPiano() {
            const pianoContainer = document.getElementById('piano');
            if (!pianoContainer) return;
            
            pianoContainer.innerHTML = '';
            let currentOctaveGroup = null;

            NOTES_SEQUENCE.forEach((keyData, index) => {
                const isOctaveStart = keyData.note.startsWith('C');
                
                if (isOctaveStart || !currentOctaveGroup) {
                    currentOctaveGroup = document.createElement('div');
                    currentOctaveGroup.classList.add('octave-group', 'flex');
                    pianoContainer.appendChild(currentOctaveGroup);
                }
                
                const isWhite = keyData.type === 'white';

                if (isWhite) {
                    const whiteKeyContainer = createKeyElement(keyData); 

                    // Verifica se a próxima nota é preta e, se for, a aninha
                    if (keyData.hasSharp && NOTES_SEQUENCE[index + 1] && NOTES_SEQUENCE[index + 1].type === 'black') {
                        const blackKeyData = NOTES_SEQUENCE[index + 1];
                        const blackKeyElement = createKeyElement(blackKeyData); 
                        
                        whiteKeyContainer.appendChild(blackKeyElement); 
                    }

                    currentOctaveGroup.appendChild(whiteKeyContainer);
                }
            });
        }
        
        /**
         * Controla a lógica de arraste do Knob.
         */
        function setupKnobControl(knobElement, effect, initialValue) {
            const marker = knobElement.querySelector('.knob-marker');
            let isDragging = false;
            const minVal = parseFloat(knobElement.getAttribute('data-min'));
            const maxVal = parseFloat(knobElement.getAttribute('data-max'));
            let currentValue = initialValue;

            // Calcula o ângulo baseado no valor (Giro de 270 graus, de -135 a 135)
            const getAngle = (value) => {
                const range = maxVal - minVal;
                const normalized = (value - minVal) / range; // 0 a 1
                return -135 + (normalized * 270); // -135deg (min) a 135deg (max)
            };

            const updateEffect = (newValue) => {
                newValue = Math.max(minVal, Math.min(maxVal, newValue));
                currentValue = parseFloat(newValue.toFixed(2));
                
                // Mapeia o valor para o Tone.js
                switch (effect) {
                    case 'reverb':
                        // O knob de Reverb controla o "wet" (mix seco/molhado)
                        masterReverb.set({ wet: currentValue });
                        break;
                    case 'chorus':
                        // O knob de Chorus controla o "wet" (mix)
                        masterChorus.set({ wet: currentValue });
                        break;
                    case 'tremolo':
                        // O knob de Tremolo controla o "wet" (mix)
                        masterTremolo.set({ wet: currentValue });
                        break;
                    case 'drive':
                        // O knob de Drive controla o "distortion" amount
                        masterDistortion.set({ distortion: currentValue });
                        break;
                }
                
                // Atualiza a visualização do marcador
                marker.style.transform = `rotate(${getAngle(currentValue)}deg)`;
                knobElement.setAttribute('data-value', currentValue);
            };

            // Inicializa a posição visual
            updateEffect(currentValue);

            const startDrag = (e) => {
                e.preventDefault();
                isDragging = true;
                knobElement.style.cursor = 'ns-resize'; // Altera o cursor
            };

            const doDrag = (e) => {
                if (!isDragging) return;
                
                // Movimento vertical (eixo Y) afeta o valor
                // O arrasto para cima (e.movementY < 0) deve aumentar o valor.
                const step = 0.01 * (maxVal / 1); // Passo de 1% do valor total
                const delta = -e.movementY * step; // Inverte o eixo Y

                let newValue = currentValue + delta;
                updateEffect(newValue);
            };

            const endDrag = () => {
                if (isDragging) {
                    isDragging = false;
                    knobElement.style.cursor = 'pointer';
                }
            };

            knobElement.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', endDrag);
        }

        /**
         * Configura todos os knobs e inicializa seus valores visuais.
         */
        function setupAllKnobs() {
            // Reverb (Inicia em 0.5, ajustado para ser o padrão do preset)
            setupKnobControl(document.getElementById('knob-reverb'), 'reverb', masterReverb.wet.value);
            // Chorus (Inicia em 0.0)
            setupKnobControl(document.getElementById('knob-chorus'), 'chorus', masterChorus.wet.value);
            // Tremolo (Inicia em 0.0)
            setupKnobControl(document.getElementById('knob-tremolo'), 'tremolo', masterTremolo.wet.value);
            // Drive/Distortion (Inicia em 0.0)
            setupKnobControl(document.getElementById('knob-drive'), 'drive', masterDistortion.distortion);
        }

        /**
         * Atualiza a posição visual de todos os knobs com base nos valores atuais do Tone.js.
         */
        function updateKnobVisuals() {
             // Simplesmente chama o setup para recalcular a posição visual inicial (o valor já está no Tone.js)
             setupAllKnobs();
        }

        // --- Eventos de Interação ---

        // Evento de pressionar tecla
        document.addEventListener('keydown', (event) => {
            const key = event.key.toLowerCase();
            const note = NOTE_BY_KEY[key];

            if (note && !event.repeat) {
                // Previne o scroll da barra de espaço
                if (key === ' ' && event.target === document.body) {
                    event.preventDefault(); 
                }
                playNote(note);
            } else if ((event.key === 'Insert' || event.keyCode === 45) && !event.repeat) {
                // Tecla INSERT (keyCode 45) para trocar de timbre
                changeTimbre(1);
            }
        });

        // Evento de soltar tecla
        document.addEventListener('keyup', (event) => {
            const key = event.key.toLowerCase();
            const note = NOTE_BY_KEY[key];

            if (note) {
                stopNote(note);
            }
        });

        // Eventos de mouse (clique/toque)
        const pianoElement = document.getElementById('piano');
        if (pianoElement) {
             pianoElement.addEventListener('mousedown', (event) => {
                if (Tone.context.state !== 'running') {
                    Tone.start().then(initializeAudio);
                } else if (!isReady) {
                    initializeAudio();
                }

                const keyElement = event.target.closest('.piano-key');
                if (keyElement) {
                    const note = keyElement.getAttribute('data-note');
                    playNote(note);
                }
            });

            pianoElement.addEventListener('mouseup', (event) => {
                const keyElement = event.target.closest('.piano-key');
                if (keyElement) {
                    const note = keyElement.getAttribute('data-note');
                    stopNote(note);
                }
            });
             // Garante que o som para ao sair da área (para evitar notas presas)
            pianoElement.addEventListener('mouseleave', () => {
                activeKeys.forEach(note => stopNote(note));
            });
        }
        
        // Inicia o contexto de áudio no primeiro clique no corpo do documento
        document.body.addEventListener('click', () => {
            if (Tone.context.state !== 'running') {
                // Tenta iniciar o áudio e a inicialização completa (incluindo knobs)
                Tone.start().then(initializeAudio); 
            } else if (!isReady) {
                initializeAudio();
            }
        }, { once: true });


        // Inicialização: Renderiza a UI do piano
        window.onload = () => {
            renderPiano();
            // Configura os listeners dos knobs (eles só se tornam funcionais após initializeAudio)
            setupAllKnobs(); 
        };
    </script>
</body>
</html>
